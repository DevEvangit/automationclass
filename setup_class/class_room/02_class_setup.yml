---
-  hosts: localhost
   connection: local
   gather_facts: yes
   vars:
    user: jesbe
    vmwhostname: vcenter.ansible.local
    vmwusername: administrator@vsphere.local
    vmwpassword: Only4Demo!
    esxihostname: esxi.ansible.local
   tasks:
#  Generate SSH Key for User
   - name: Generate SSH keys
     user:
       name: "{{ user }}"
       generate_ssh_key: yes
       ssh_key_bits: 2048
       ssh_key_file: .ssh/id_rsa

   - name: Change NFS.MaxVolumes setting for an ESXi host
     vmware_host_config_manager:
       hostname: "{{ vmwhostname }}"
       username: "{{ vmwusername }}"
       password: "{{ vmwpassword }}"
       validate_certs: False
       esxi_hostname: "{{ esxihostname }}"
       options:
         'NFS.MaxVolumes': '16'
         'NFS41.MaxVolumes': '16'

   - name: Clone fedora 30 to storage.ansible.local
     vmware_guest:
       hostname: "{{ vmwhostname }}"
       username: "{{ vmwusername }}"
       password: "{{ vmwpassword }}"
       validate_certs: False
       name: storage.ansible.local
       template: _TEMP_fedora30
       datacenter: Datacenter
       folder: /Admin
       state: poweredon
       wait_for_ip_address: yes
     register: storagevm

   - name: IP address info
     debug:
       msg: "{{ storagevm.instance.ipv4 }}"

   - name: Set Fact storagevm_ip_fact
     set_fact:
      storagevm_ip_fact: "{{ storagevm.instance.ipv4 }}"

   - name: IP address info
     debug:
       msg: "{{ storagevm_ip_fact }}"   

   - name: add storagevm to ansible in memory host file
     add_host:
      name: "{{ storagevm_ip_fact }}"
      groups: storagetmp
     when: storagevm_ip_fact != "10.172.10.12"

   - name: Copy SSH ID
     shell: |
      ssh-copy-id "{{ user }}@{{ storagevm_ip_fact }}"

-  hosts: storagetmp
   become: yes
   vars:
     storagevm_ip_fact: "{{ hostvars['localhost']['storagevm_ip_fact'] }}"
   tasks:
   - name: IP address info
     debug:
       msg: "{{ storagevm_ip_fact }}"  
   
   - name: configure network
     shell: |
      nmcli connection modify ens192 -ipv4.addresses "{{ ansible_default_ipv4.address }}/24"
      nmcli connection modify ens192 ipv4.addresses "10.172.10.12/24"
      nmcli connection modify ens192 ipv4.gateway "10.172.10.1"
      nmcli connection modify ens192 ipv4.dns "10.172.10.2"
      nmcli connection modify ens192 ipv4.method manual
      shutdown -r +1
     when: storagevm_ip_fact != "10.172.10.12"

-  hosts: localhost
   vars:
   tasks:
   - name: remove ssh knownhost
     known_hosts:
       path: ~/.ssh/known_hosts
       name: "{{ storagevm.instance.ipv4 }}"
       state: absent
     when: storagevm_ip_fact != "10.172.10.12"    
    